<!DOCTYPE html>

<html>
<head>
	<meta charset="windows-1251" />
	<title>GeoTracert via leaflet</title>
	<!-- Добавляем файлы стилей CSS для библиотеки -->
	<link rel="stylesheet" href="style/leaflet.css" />
	<link rel="stylesheet" href="style/style.css" />
	<!--[if lte IE 8]>
		<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5/leaflet.ie.css" />
	<![endif]-->

	<!-- Добавляем ссылку на JS-скрипт библиотеки -->
	<script src="http://cdn.leafletjs.com/leaflet-0.5/leaflet.js"></script>
	<script src="http://code.jquery.com/jquery-1.8.3.min.js"></script>
	<script src="http://api-maps.yandex.ru/2.0/?load=package.map&lang=ru-RU" type="text/javascript"></script>
	<script src="http://maps.google.com/maps/api/js?v=3.2&sensor=false"></script>
	
	<script src="layer/Google.js"></script>	
	<script src="layer/Yandex.js"></script>
	<script src="list/iplist.js"></script>

</head>

<script type="text/javascript">
var map;
var pointsList;
var polyline;
	window.onload=function(){

		//Определяем карту, координаты центра и начальный масштаб
		map = L.map('map').setView([60,20], 8);
		var mypol = new Array();
	
        //определим слои карт
		var osm = new L.TileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
		var cldmd = new L.tileLayer('http://{s}.tile.cloudmade.com/56eded06210846ecbb758f29e7c28152/997/256/{z}/{x}/{y}.png', {
			attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://cloudmade.com">CloudMade</a>',
			maxZoom: 18 });
		// Possible types: map, satellite, hybrid, publicMap, publicMapHybrid
		var yndx = new L.Yandex();
		// Possible types: SATELLITE, ROADMAP, HYBRID, TERRAIN
		var googleRoadMap = new L.Google('ROADMAP');
		
		map.addLayer(osm);

		map.addControl(new L.Control.Layers({'OSM':osm, 'CloudMade':cldmd, 'Yandex':yndx, 'Google-дорожная карта':googleRoadMap},{}, {collapsed: false}));
		
		document.getElementById('SearchButton').onclick = verify;
		
		document.getElementById('InputBox').onkeyup = function(){
			this.value = this.value.replace(/[^\d\.]/g, '');
		}
		
		function verify(){		//Валидация введённого значения

			var valid = /^(25[0-5]|2[0-4][0-9]|[0-1][0-9]{2}|[0-9]{2}|[0-9])(\.(25[0-5]|2[0-4][0-9]|[0-1][0-9]{2}|[0-9]{2}|[0-9])){3}$/;
			var textbox = document.getElementById('InputBox');
			// Для поиска отправляется запрос.
			if(textbox.value == ""){
				alert('Введите данные в поле!');
			}
			else if(!valid.test(textbox.value)){
				alert('Неверно введен IP');
			}
			else {
				var temp = myPointsToo;
				myPointsToo = myPoints;
				myPoints = temp;
				if(polyline) {
					map.removeLayer(polyline);
				}
				if(pointsList) {
					for(var iter = 0; iter < pointsList.length; iter++)
						map.removeLayer(pointsList[iter]);
				}
				pointsList = new Array();
				listing();
				mypol = new Array();
				for(var i = 0; i < myPoints.length; i++){
					mypol.push(myPoints[i].coords);
					pointsList.push(L.marker(myPoints[i].coords));
					pointsList[i].addTo(map);
					pointsList[i].bindPopup(myPoints[i].text);
				};
		
				// ломаная между точками
				polyline = L.polyline(mypol,{
					color: 'blue',							//цвет
					weight: 5,								//толщина
					opacity: 0.9,							//мутность
					smoothFactor: 1
				});
				polyline.addTo(map);

				// в фокусе все метки
				map.fitBounds(polyline.getBounds());
			}
			textbox.value = "";
			textbox.focus();
		}
				
		function listing () {

			var line = new Array(myPoints.length);
			var table = document.getElementById('table');
			table.innerHTML = '';
			for(var i=0; i < myPoints.length; i++)
				table.innerHTML += '<li>IP: <a id="ipline' + i + '" href="javascript:map.setView([' + myPoints[i].coords[0] + ', ' + myPoints[i].coords[1] + '], 18);">' + myPoints[i].ip + '</li>';
		}
};


</script>

<body>
	<div id="main">
		<h1><font face="comic sans ms">Welcome to Geotracert service</font></h1>
		<div id="wrapper">
		<div id="frame">
          <div id="map"> </div>
		</div>
		<div id="inright">
			<input type="text" id="InputBox" placeholder="Введите IP для поиска" size="21" value=""/>
			<input type="submit" id="SearchButton" value="Пуск"/>
			<div id="list">
				<ol id="table" align="left"/>
			</div>
		</div>
		</div>
	</div>
</body>

</html>